name: Rust CLI Release

on:
  # å½“ä¸€ä¸ªæ–°çš„ Tag (ä¾‹å¦‚ v1.0.0) è¢«æŽ¨é€åˆ°ä»“åº“æ—¶è§¦å‘
  push:
    tags:
      - "v[0-9]+.*" # åŒ¹é…æ‰€æœ‰ä»¥ 'v' å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾

jobs:
  build_and_release:
    name: Build & Release on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    # å®šä¹‰ç¼–è¯‘å¹³å°çŸ©é˜µ
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # æ­¥éª¤ 1ï¼šè®¾ç½® Rust ç¼–è¯‘çŽ¯å¢ƒ
      # ------------------------------------------------------------------
      - name: ðŸ› ï¸ Setup Rust environment
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      # ------------------------------------------------------------------
      # æ­¥éª¤ 2ï¼šç¼–è¯‘ç¨‹åº
      # ------------------------------------------------------------------
      - name: ðŸ—ï¸ Compile CLI Tool (Release)
        id: compile
        run: |
          VERSION=${{ github.ref_name }}
          # å‡è®¾ä½ çš„é¡¹ç›®ååœ¨ Cargo.toml ä¸­æ˜¯ 'mytool'
          PROJECT_NAME="transfer"

          # ä½¿ç”¨ --release ç¼–è¯‘ï¼Œç”Ÿæˆä¼˜åŒ–çš„äºŒè¿›åˆ¶æ–‡ä»¶
          cargo build --release

          # ç¡®å®šå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„å’Œæœ€ç»ˆåç§°
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            EXECUTABLE_PATH="target/release/${PROJECT_NAME}.exe"
            OUTPUT_NAME="${PROJECT_NAME}-${VERSION}-windows-x64.zip"
          else
            EXECUTABLE_PATH="target/release/${PROJECT_NAME}"
            OUTPUT_NAME="${PROJECT_NAME}-${VERSION}-${{ matrix.os }}-x64.tar.gz"
          fi

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "executable_path=${EXECUTABLE_PATH}" >> $GITHUB_OUTPUT
          echo "output_name=${OUTPUT_NAME}" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # æ­¥éª¤ 3ï¼šæ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
      # ------------------------------------------------------------------
      - name: ðŸ“¦ Archive (Tar for Linux/macOS, Zip for Windows)
        id: archive
        run: |
          OUTPUT_NAME=${{ steps.compile.outputs.output_name }}
          EXECUTABLE_PATH=${{ steps.compile.outputs.executable_path }}
          PROJECT_NAME=${{ steps.compile.outputs.project_name }}

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            # Windows ä½¿ç”¨ zip
            # éœ€è¦å®‰è£… zip å·¥å…·
            # Add-Type -AssemblyName System.IO.Compression.FileSystem
            # [System.IO.Compression.ZipFile]::CreateFromDirectory(".", "$OUTPUT_NAME")
            # ä½¿ç”¨ powershell çš„ Compress-Archive
            Compress-Archive -Path $EXECUTABLE_PATH -DestinationPath $OUTPUT_NAME
          else
            # Linux/macOS ä½¿ç”¨ tar.gz
            tar -czvf $OUTPUT_NAME -C "$(dirname $EXECUTABLE_PATH)" "$(basename $EXECUTABLE_PATH)"
          fi

          # è®¾ç½®æ‰“åŒ…æ–‡ä»¶çš„è·¯å¾„ä¾›ä¸‹ä¸€æ­¥ä¸Šä¼ ä½¿ç”¨
          echo "asset_path=$OUTPUT_NAME" >> $GITHUB_OUTPUT
          echo "asset_name=$OUTPUT_NAME" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # æ­¥éª¤ 4ï¼šåˆ›å»ºå’Œä¸Šä¼  Release Assets
      # ------------------------------------------------------------------
      - name: ðŸš€ Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          draft: false
          prerelease: false
          files: ${{ steps.archive.outputs.asset_path }}
